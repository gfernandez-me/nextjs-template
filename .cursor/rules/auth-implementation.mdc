# Authentication Implementation (Better Auth)

This project uses Better Auth with the Prisma adapter for email/password authentication and session management.

## Implementation Details

### 1. Prisma Schema (Auth Models)

```prisma
// See `prisma/schema.prisma` for full models
// Key points:
// - Passwords are stored in `Account.password`, not `User`
// - Credentials provider uses providerId = "credential"
// - Session tokens are stored in `Session`
```

### 2. Auth Setup

- Library: Better Auth
- Adapter: Prisma
- Email & Password enabled
- Theme: handled via `next-themes`

### 3. Key Files

- `src/lib/auth.ts` - Better Auth configuration (uses prisma singleton)
- `src/lib/auth-client.ts` - Better Auth client
- `src/app/(dashboard)/layout.tsx` - Redirects unauthenticated users to `/login`
- `src/components/auth/login-form.tsx` - Login form using `authClient`

### 4. Database Setup

#### Required Commands

```bash
# Generate Prisma client
npm run db:generate

# Run migrations (creates tables)
npm run db:migrate

# Seed database (creates admin user + credentials account)
npx tsx prisma/seed.ts
```

#### What Gets Created

- **Admin User**: `admin@epic7optimizer.com` / `admin1234`
- **Default Settings**: Scoring weights, thresholds, fScore configuration
- **Database Tables**: Users, Gears, Heroes, SubStats, StatTypes, GearSets, Settings

### 5. Default Admin User

- **Email**: admin@epic7optimizer.com
- **Password**: admin1234 (stored in `Account.password` hashed via Better Auth)
- **ID**: admin-user
- **Created**: Via `prisma/seed.ts` using Better Auth `hashPassword`

### 6. Notes

- Passwords are hashed with Better Auth’s built-in hasher.
- `providerId` for credentials is "credential".
- To add a password for OAuth users, use `auth.api.setPassword`.

Reference: Better Auth users & accounts [docs](https://www.better-auth.com/docs/concepts/users-accounts)

### 7. User Experience

- Profile page showing user information
- Password change functionality
- Sign in/out from navigation
- Responsive design with shadcn/ui components
- Loading states and error handling

### 8. API Endpoints

- `POST /api/auth/signin` - User sign in
- `POST /api/auth/signout` - User sign out
- `GET /api/auth/me` - **DEPRECATED** - Use better-auth session instead
- `POST /api/auth/change-password` - Change user password

### 9. Dependencies Added

- `jsonwebtoken` - JWT token handling
- `@types/jsonwebtoken` - TypeScript types
- `bcryptjs` - Password hashing
- `@types/bcryptjs` - TypeScript types
- `tsx` - TypeScript execution for seeding

### 10. Route Protection

**Protected Routes** (require authentication):

- `/profile` - User profile
- `/settings` - App settings
- `/upload` - Gear upload

**Public Routes**:

- `/` - Home page
- `/signin` - Sign in page
- `/statistics` - Gear statistics

### 11. Client-Side Authentication

- Better Auth for session management and authentication
- Automatic token refresh on page load
- Loading states during authentication
- Automatic redirects based on auth status

## Usage

1. **Setup Database**: Run `npm run db:seed` after migrations
2. **Sign In**: Navigate to `/signin` or click "Sign In" button
3. **Profile**: Access via navigation or `/profile` route
4. **Password Change**: Use form in profile page
5. **Sign Out**: Click "Sign Out" button in navigation

## Database Seeding

The system includes a comprehensive seeder that creates:

- Default admin user with secure password
- Application settings with scoring weights
- Threshold values for gear quality badges
- fScore configuration for optimization

**Seed Command**: `npm run db:seed`

## Environment Variables

Add to your `.env` file:

```
JWT_SECRET=your-secure-secret-key-here
DATABASE_URL=postgresql://username:password@localhost:5432/database_name
```

## Troubleshooting

### Common Issues

#### Admin Login Not Working

If you can't sign in with the default admin account:

1. **Check Database Seeding**: Ensure `npm run db:seed` was run successfully
2. **Verify User Exists**: Check that admin user exists in the database
3. **Password Format**: Use exactly `admin@epic7optimizer.com` / `admin1234`
4. **Whitespace Issues**: The system now trims input to prevent whitespace problems
5. **Password Reset**: If issues persist, manually reset via Prisma Studio

#### Password Hash Issues

The system uses bcrypt with 12 rounds for password hashing. If authentication fails:

- Verify the password hash in the database is valid
- Check that bcryptjs is properly installed
- Ensure the password comparison is working correctly

### Debug Steps

1. **Check Server Logs**: Look for authentication errors in console
2. **Verify Database**: Use Prisma Studio to check user table
3. **Test Password Hash**: Manually verify bcrypt comparison
4. **Check Environment**: Ensure JWT_SECRET is set correctly

## Build Status

✅ **Build Successful**: All authentication components compile without errors
✅ **Type Safety**: Full TypeScript support with proper interfaces
✅ **Route Protection**: Middleware properly protects authenticated routes
✅ **API Endpoints**: All auth endpoints working correctly
✅ **Database Seeding**: Admin user and settings created successfully
✅ **Authentication Fixed**: Password hashing and comparison working correctly
